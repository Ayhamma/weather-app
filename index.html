<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã (v3)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#38bdf8;
      --danger:#f97373;
      --card: rgba(17,24,39,0.82);
      --border: rgba(148,163,184,0.28);

      /* –§–æ–Ω –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS */
      --bg: radial-gradient(circle at top, #1f2937 0, #020617 55%);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      color:var(--text);
      background: var(--bg);
      transition: background 350ms ease;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background: radial-gradient(circle at 20% 10%, rgba(56,189,248,0.10), rgba(2,6,23,0.55));
      pointer-events:none;
    }

    .app{
      position:relative;
      width:100%;
      max-width:980px;
      background: rgba(15,23,42,0.76);
      border:1px solid rgba(148,163,184,0.22);
      border-radius:22px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      padding:18px;
      backdrop-filter: blur(18px);
      z-index:1;
    }

    header{
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .title{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .icon{
      width:38px;height:38px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background: radial-gradient(circle at 30% 30%, #fbbf24, #f97316);
      box-shadow: 0 0 22px rgba(250,204,21,0.55);
      font-size:20px;
    }
    h1{font-size:20px;font-weight:650;letter-spacing:.03em}
    .subtitle{font-size:12px;color:var(--muted);margin-top:2px}

    .btn{
      border:none;
      border-radius:999px;
      padding:9px 14px;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color:white;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:0 10px 20px rgba(34,197,94,0.35);
      transition: transform .1s ease, opacity .1s ease;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    .btn[disabled]{opacity:.6;cursor:default;box-shadow:none}

    .layout{
      display:grid;
      grid-template-columns: 2fr 1.1fr;
      gap:14px;
    }

    .panel{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }

    .panelHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .panelHead h2{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:var(--muted);
    }

    .badge{
      display:inline-flex;
      gap:6px;
      align-items:center;
      font-size:11px;
      color:var(--accent);
      background: rgba(56,189,248,0.12);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,0.22);
    }

    .geoLine{
      font-size:12px;
      color:var(--text);
      margin-top:6px;
    }
    .geoLine span{color:var(--accent)}

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }

    .tab{
      border:1px solid rgba(148,163,184,0.38);
      background: transparent;
      color: var(--muted);
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .tab.active{
      background: rgba(56,189,248,0.12);
      color: var(--text);
      border-color: rgba(56,189,248,0.65);
      transform: translateY(-1px);
    }
    .tab small{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color: var(--accent);
    }

    .formBox{
      margin-top:10px;
      padding:10px;
      border-radius:16px;
      background: rgba(2,6,23,0.70);
      border: 1px dashed rgba(148,163,184,0.40);
    }
    .formBox h3{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:8px;
    }
    .row{
      position:relative;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    input[type="text"]{
      flex:1;
      min-width:220px;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.55);
      background: rgba(2,6,23,0.72);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    input[type="text"]:focus{
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.18);
    }

    .addBtn{
      border:none;
      background: var(--accent);
      color:#020617;
      border-radius:10px;
      padding:9px 14px;
      font-size:13px;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 10px 20px rgba(56,189,248,0.25);
    }
    .addBtn:active{transform: translateY(1px)}
    .addBtn[disabled]{opacity:.6;cursor:default;box-shadow:none}

    .suggestions{
      position:absolute;
      left:0; right:0;
      top:100%;
      margin-top:6px;
      background: rgba(2,6,23,0.98);
      border:1px solid rgba(148,163,184,0.55);
      border-radius:10px;
      max-height:190px;
      overflow:auto;
      z-index:10;
      display:none;
    }
    .sItem{
      padding:8px 10px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      cursor:pointer;
      font-size:13px;
    }
    .sItem:hover{background: rgba(15,23,42,0.95)}
    .sItem .right{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:55%;
      text-align:right;
    }

    .hint{font-size:11px;color:var(--muted);margin-top:8px}
    .err{font-size:12px;color:var(--danger);margin-top:8px;display:none}

    .weatherHead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:baseline;
      margin-bottom:8px;
    }
    .weatherHead .loc{
      font-size:12px;
      color:var(--text);
      font-weight:550;
    }
    .weatherHead .loc span{color:var(--accent)}

    .status{font-size:13px;color:var(--muted)}
    .status.error{color:var(--danger)}

    .days{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .day{
      border-radius:16px;
      padding:10px;
      border:1px solid rgba(148,163,184,0.22);
      background: radial-gradient(circle at top, rgba(56,189,248,0.16), rgba(2,6,23,0.80));
    }
    .day.today{box-shadow: 0 0 0 1px rgba(56,189,248,0.55)}
    .dName{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .dDate{font-size:11px;color:var(--muted);margin-top:2px}
    .temps{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-top:8px;
      gap:8px;
    }
    .tMax{font-size:22px;font-weight:700}
    .tMin{font-size:12px;color:var(--muted)}
    .desc{font-size:12px;color:var(--muted);margin-top:6px}

    @media (max-width: 800px){
      .layout{grid-template-columns: 1fr}
    }
    @media (max-width: 540px){
      .days{grid-template-columns:1fr}
      .btn{width:100%;justify-content:center}
      input[type="text"]{min-width:0;width:100%}
      .addBtn{width:100%}
      .row{flex-direction:column}
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="icon">‚òÄÔ∏è</div>
        <div>
          <h1>–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã</h1>
          <div class="subtitle">–°–µ–≥–æ–¥–Ω—è + 2 –¥–Ω—è ‚Ä¢ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏–ª–∏ –ª—é–±—ã–µ –≥–æ—Ä–æ–¥–∞ –º–∏—Ä–∞</div>
        </div>
      </div>
      <button id="refreshBtn" class="btn"><span>‚ü≥</span> –û–±–Ω–æ–≤–∏—Ç—å</button>
    </header>

    <div class="layout">
      <section class="panel">
        <div class="panelHead">
          <h2>–ì–æ—Ä–æ–¥–∞</h2>
          <div>
            <div class="badge" id="badgeText">üìç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</div>
            <div class="geoLine" id="geoLine" style="display:none;">
              –ù–∞–π–¥–µ–Ω–æ: <span id="geoName">‚Äî</span>
            </div>
          </div>
        </div>

        <div class="tabs" id="tabs"></div>

        <div class="formBox">
          <h3>–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥</h3>
          <div class="row">
            <input id="cityInput" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥‚Ä¶" autocomplete="off" />
            <button id="addBtn" class="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
            <div id="sug" class="suggestions"></div>
          </div>
          <div id="err" class="err"></div>
          <div class="hint">–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (—Ç–æ–≥–¥–∞ –±—É–¥—É—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã).</div>
        </div>
      </section>

      <section class="panel">
        <div class="weatherHead">
          <h2 style="font-size:13px;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);">–ü—Ä–æ–≥–Ω–æ–∑</h2>
          <div class="loc">–õ–æ–∫–∞—Ü–∏—è: <span id="activeName">‚Äî</span></div>
        </div>

        <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        <div id="days" class="days"></div>
      </section>
    </div>
  </div>

  <script>
    // =========================
    // 0) –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    // =========================
    const KEY_CITIES = 'wx.cities.v3';
    const KEY_SELECTED = 'wx.selected.v3';

    /** city object:
     * { id, name, lat, lon, isCurrent }
     */
    const state = {
      cities: [],
      selectedId: null,
      loading: false
    };

    const el = {
      refreshBtn: document.getElementById('refreshBtn'),
      badgeText: document.getElementById('badgeText'),
      geoLine: document.getElementById('geoLine'),
      geoName: document.getElementById('geoName'),
      tabs: document.getElementById('tabs'),

      input: document.getElementById('cityInput'),
      addBtn: document.getElementById('addBtn'),
      sug: document.getElementById('sug'),
      err: document.getElementById('err'),

      activeName: document.getElementById('activeName'),
      status: document.getElementById('status'),
      days: document.getElementById('days')
    };

    function save() {
      localStorage.setItem(KEY_CITIES, JSON.stringify(state.cities));
      localStorage.setItem(KEY_SELECTED, state.selectedId || '');
    }
    function load() {
      try{
        const c = localStorage.getItem(KEY_CITIES);
        const s = localStorage.getItem(KEY_SELECTED);
        if (c) {
          const parsed = JSON.parse(c);
          if (Array.isArray(parsed)) state.cities = parsed;
        }
        if (s) state.selectedId = s;
      }catch(e){
        console.warn('localStorage read error', e);
      }
    }

    function uid() {
      return 'c_' + Math.random().toString(36).slice(2, 10);
    }

    // =========================
    // 1) –ì–µ–æ–∫–æ–¥–∏–Ω–≥ (–ø–æ–∏—Å–∫) + Reverse (–∫–æ–æ—Ä–¥ -> –≥–æ—Ä–æ–¥)
    // =========================
    async function geocodeSearch(query) {
      const q = (query || '').trim();
      if (q.length < 2) return [];

      const url = new URL('https://geocoding-api.open-meteo.com/v1/search');
      url.searchParams.set('name', q);
      url.searchParams.set('count', '10');
      url.searchParams.set('language', 'ru');
      url.searchParams.set('format', 'json');

      const r = await fetch(url.toString());
      if (!r.ok) throw new Error('Geocoding HTTP ' + r.status);
      const data = await r.json();
      return Array.isArray(data.results) ? data.results : [];
    }

    async function reverseCity(lat, lon) {
      const url = new URL('https://geocoding-api.open-meteo.com/v1/reverse');
      url.searchParams.set('latitude', String(lat));
      url.searchParams.set('longitude', String(lon));
      url.searchParams.set('language', 'ru');
      url.searchParams.set('format', 'json');

      const r = await fetch(url.toString());
      if (!r.ok) throw new Error('Reverse HTTP ' + r.status);
      const data = await r.json();
      const first = Array.isArray(data.results) ? data.results[0] : null;
      if (!first) return null;

      const parts = [first.name, first.admin1, first.country].filter(Boolean);
      return parts.join(', ');
    }

    // =========================
    // 2) –ü–æ–≥–æ–¥–∞ (Open-Meteo) + —Ñ–æ–Ω
    // =========================
    function wxText(code) {
      const map = [
        { codes:[0], text:'–Ø—Å–Ω–æ' },
        { codes:[1,2], text:'–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å' },
        { codes:[3], text:'–ü–∞—Å–º—É—Ä–Ω–æ' },
        { codes:[45,48], text:'–¢—É–º–∞–Ω' },
        { codes:[51,53,55,56,57], text:'–ú–æ—Ä–æ—Å—å' },
        { codes:[61,63,65], text:'–î–æ–∂–¥—å' },
        { codes:[66,67], text:'–õ–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å' },
        { codes:[71,73,75,77], text:'–°–Ω–µ–≥' },
        { codes:[80,81,82], text:'–õ–∏–≤–µ–Ω—å' },
        { codes:[95,96,99], text:'–ì—Ä–æ–∑–∞' },
      ];
      const f = map.find(x => x.codes.includes(code));
      return f ? f.text : `–ö–æ–¥ ${code}`;
    }

    function setBg(code){
      // –°–¥–µ–ª–∞–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∑–∞–º–µ—Ç–Ω–æ
      let bg;
      if (code === 0) bg = 'radial-gradient(circle at 20% 15%, rgba(250,204,21,0.42), rgba(2,6,23,0.72)), linear-gradient(180deg,#0b1223,#020617)';
      else if ([1,2,3].includes(code)) bg = 'radial-gradient(circle at 30% 15%, rgba(148,163,184,0.36), rgba(2,6,23,0.78)), linear-gradient(180deg,#0b1223,#020617)';
      else if ([45,48].includes(code)) bg = 'radial-gradient(circle at 30% 15%, rgba(203,213,225,0.32), rgba(2,6,23,0.85)), linear-gradient(180deg,#0b1223,#020617)';
      else if ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) bg = 'radial-gradient(circle at 25% 15%, rgba(56,189,248,0.34), rgba(2,6,23,0.88)), linear-gradient(180deg,#07111f,#020617)';
      else if ([71,73,75,77].includes(code)) bg = 'radial-gradient(circle at 25% 15%, rgba(226,232,240,0.34), rgba(2,6,23,0.86)), linear-gradient(180deg,#081227,#020617)';
      else if ([95,96,99].includes(code)) bg = 'radial-gradient(circle at 25% 15%, rgba(168,85,247,0.30), rgba(2,6,23,0.92)), linear-gradient(180deg,#070a12,#020617)';
      else bg = 'radial-gradient(circle at top, #1f2937 0, #020617 55%)';

      document.documentElement.style.setProperty('--bg', bg);
    }

    async function fetchWeather(lat, lon) {
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      url.searchParams.set('latitude', String(lat));
      url.searchParams.set('longitude', String(lon));
      url.searchParams.set('daily', 'weathercode,temperature_2m_max,temperature_2m_min');
      url.searchParams.set('forecast_days', '3');
      url.searchParams.set('timezone', 'auto');

      const r = await fetch(url.toString());
      if (!r.ok) throw new Error('Weather HTTP ' + r.status);

      const data = await r.json();
      if (!data.daily) throw new Error('Bad API response');

      const time = data.daily.time;
      const tMax = data.daily.temperature_2m_max;
      const tMin = data.daily.temperature_2m_min;
      const code = data.daily.weathercode;

      return time.map((d,i)=>({ date:d, max:tMax[i], min:tMin[i], code:code[i] }));
    }

    function dayName(dateStr, idx){
      if (idx===0) return '–°–µ–≥–æ–¥–Ω—è';
      if (idx===1) return '–ó–∞–≤—Ç—Ä–∞';
      const d = new Date(dateStr);
      return d.toLocaleDateString('ru-RU',{weekday:'short'});
    }
    function dayDate(dateStr){
      const d = new Date(dateStr);
      return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});
    }

    // =========================
    // 3) UI
    // =========================
    function setErr(msg){
      el.err.textContent = msg || '';
      el.err.style.display = msg ? 'block' : 'none';
    }

    function setStatus(msg, type){
      el.status.textContent = msg;
      el.status.className = 'status' + (type === 'error' ? ' error' : '');
      el.status.style.display = 'block';
    }

    function renderTabs(){
      el.tabs.innerHTML = '';
      if (!state.cities.length){
        el.tabs.innerHTML = '<div class="status">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤.</div>';
        return;
      }

      state.cities.forEach(c=>{
        const b = document.createElement('button');
        b.className = 'tab' + (c.id===state.selectedId ? ' active' : '');
        b.innerHTML = `<span>${c.name}</span>${c.isCurrent ? '<small>—Ç–µ–∫—É—â–µ–µ</small>' : ''}`;
        b.addEventListener('click', ()=>{
          if (state.selectedId !== c.id){
            state.selectedId = c.id;
            save();
            renderTabs();
            loadAndRenderSelected();
          }
        });
        el.tabs.appendChild(b);
      });
    }

    function renderDays(cityName, days){
      el.activeName.textContent = cityName;
      el.days.innerHTML = '';
      el.status.style.display = 'none';

      days.forEach((d,idx)=>{
        const card = document.createElement('div');
        card.className = 'day' + (idx===0 ? ' today' : '');
        card.innerHTML = `
          <div class="dName">${dayName(d.date, idx)}</div>
          <div class="dDate">${dayDate(d.date)}</div>
          <div class="temps">
            <div class="tMax">${Math.round(d.max)}¬∞</div>
            <div class="tMin">–æ—Ç ${Math.round(d.min)}¬∞</div>
          </div>
          <div class="desc">${wxText(d.code)}</div>
        `;
        el.days.appendChild(card);
      });
    }

    function setLoading(on){
      state.loading = on;
      el.refreshBtn.disabled = on;
      if (on){
        setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞‚Ä¶');
        el.days.innerHTML = '';
      }
    }

    // =========================
    // 4) –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥
    // =========================
    async function loadAndRenderSelected(){
      const c = state.cities.find(x => x.id === state.selectedId);
      if (!c){
        setStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π.');
        el.days.innerHTML = '';
        return;
      }

      setLoading(true);
      try{
        const days = await fetchWeather(c.lat, c.lon);
        renderDays(c.name, days);

        // –§–æ–Ω –ø–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –ø–æ–≥–æ–¥–µ (–æ—á–µ–Ω—å –∑–∞–º–µ—Ç–Ω–æ)
        setBg(days[0]?.code ?? 0);

      }catch(e){
        console.error(e);
        setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'error');
      }finally{
        setLoading(false);
      }
    }

    // =========================
    // 5) –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º –ù–ê–ó–í–ê–ù–ò–ï –≥–æ—Ä–æ–¥–∞
    // =========================
    async function ensureCurrentCityName(){
      const current = state.cities.find(x => x.isCurrent);
      if (!current) return;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞–π–¥–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥
      el.geoLine.style.display = 'none';

      try{
        const name = await reverseCity(current.lat, current.lon);
        if (name){
          current.name = name;          // –û–ë–ù–û–í–õ–Ø–ï–ú –∏–º—è
          save();
          renderTabs();

          el.geoName.textContent = name;
          el.geoLine.style.display = 'block';
        }
      }catch(e){
        console.warn('reverse geocode failed', e);
      }
    }

    function requestGeolocation(){
      if (!navigator.geolocation){
        el.badgeText.textContent = 'üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        setStatus('–î–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é.');
        return;
      }

      el.badgeText.textContent = 'üìç –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Ä¶';
      el.geoLine.style.display = 'none';

      navigator.geolocation.getCurrentPosition(
        async (pos)=>{
          const { latitude, longitude } = pos.coords;

          // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º current
          let current = state.cities.find(x => x.isCurrent);
          if (!current){
            current = { id: uid(), name: '–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', lat: latitude, lon: longitude, isCurrent: true };
            state.cities.unshift(current);
          } else {
            current.lat = latitude;
            current.lon = longitude;
          }

          // –í—ã–±–∏—Ä–∞–µ–º current
          state.selectedId = current.id;
          save();
          renderTabs();

          // –ó–∞—Ç–µ–º –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è –≥–æ—Ä–æ–¥–∞
          try{
            const nm = await reverseCity(latitude, longitude);
            if (nm){
              current.name = nm;
              save();
              renderTabs();

              el.geoName.textContent = nm;
              el.geoLine.style.display = 'block';
            }
          }catch(e){
            console.warn('reverse geocode failed', e);
          }

          el.badgeText.textContent = 'üìç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
          loadAndRenderSelected();
        },
        (err)=>{
          console.warn(err);
          el.badgeText.textContent = 'üìç –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω—ë–Ω';
          el.geoLine.style.display = 'none';
          setStatus('–î–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥ –≤—Ä—É—á–Ω—É—é.');
        },
        { enableHighAccuracy:true, timeout: 10000, maximumAge: 60000 }
      );
    }

    // =========================
    // 6) –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –º–∏—Ä–∞ (autocomplete)
    // =========================
    let debounce = null;
    function hideSug(){ el.sug.style.display = 'none'; el.sug.innerHTML = ''; }
    function showSug(items){
      el.sug.innerHTML = '';
      if (!items.length){ hideSug(); return; }

      items.forEach(p=>{
        const right = [p.admin1, p.country].filter(Boolean).join(', ');
        const row = document.createElement('div');
        row.className = 'sItem';
        row.innerHTML = `<div>${p.name}</div><div class="right">${right}</div>`;
        row.addEventListener('click', ()=>{
          const label = right ? `${p.name}, ${right}` : p.name;
          el.input.value = label;
          el.input.dataset.lat = String(p.latitude);
          el.input.dataset.lon = String(p.longitude);
          hideSug();
        });
        el.sug.appendChild(row);
      });

      el.sug.style.display = 'block';
    }

    async function onInput(){
      setErr('');
      delete el.input.dataset.lat;
      delete el.input.dataset.lon;

      const q = el.input.value.trim();
      if (q.length < 2){ hideSug(); return; }

      clearTimeout(debounce);
      debounce = setTimeout(async ()=>{
        try{
          const res = await geocodeSearch(q);
          showSug(res);
        }catch(e){
          console.error(e);
          hideSug();
          setErr('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        }
      }, 250);
    }

    function addCity(){
      setErr('');
      hideSug();

      const label = el.input.value.trim();
      const lat = el.input.dataset.lat;
      const lon = el.input.dataset.lon;

      if (!label) { setErr('–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫.'); return; }
      if (!lat || !lon) { setErr('–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥ –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–∏–Ω–∞—á–µ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç).'); return; }

      const exists = state.cities.some(c => String(c.lat)===String(lat) && String(c.lon)===String(lon));
      if (exists) { setErr('–≠—Ç–æ—Ç –≥–æ—Ä–æ–¥ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω.'); return; }

      const c = { id: uid(), name: label, lat: Number(lat), lon: Number(lon), isCurrent: false };
      state.cities.push(c);
      if (!state.selectedId) state.selectedId = c.id;

      save();
      renderTabs();
      loadAndRenderSelected();

      el.input.value = '';
      delete el.input.dataset.lat;
      delete el.input.dataset.lon;
    }

    // =========================
    // 7) INIT
    // =========================
    function init(){
      load();
      renderTabs();

      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π current ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–∏–º –∏–º—è –≥–æ—Ä–æ–¥–∞
      if (state.cities.length){
        // –∏—Å–ø—Ä–∞–≤–ª—è–µ–º selected –µ—Å–ª–∏ —Å–ª–æ–º–∞–Ω
        if (!state.selectedId || !state.cities.some(c=>c.id===state.selectedId)){
          state.selectedId = state.cities[0].id;
          save();
        }

        const hasCurrent = state.cities.some(c=>c.isCurrent);
        el.badgeText.textContent = hasCurrent
          ? 'üìç –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
          : 'üìç –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞';

        // –í–∞–∂–Ω–æ: –æ–±–Ω–æ–≤–∏—Ç—å –∏–º—è –≥–æ—Ä–æ–¥–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º, –µ—Å–ª–∏ –µ—Å—Ç—å current
        ensureCurrentCityName();

        loadAndRenderSelected();
      } else {
        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –ø—Ä–æ—Å–∏–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
        requestGeolocation();
      }
    }

    // –°–æ–±—ã—Ç–∏—è
    el.refreshBtn.addEventListener('click', ()=>{
      // –û–±–Ω–æ–≤–∏—Ç—å: –µ—Å–ª–∏ –µ—Å—Ç—å current ‚Äî –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ–∂–µ
      // –Ω–æ —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å –∑–∞–ø—Ä–æ—Å–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å–∏–º –ø–æ–≥–æ–¥—É
      loadAndRenderSelected();
    });

    el.input.addEventListener('input', onInput);
    el.input.addEventListener('blur', ()=> setTimeout(hideSug, 200));
    el.addBtn.addEventListener('click', addCity);
    el.input.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); addCity(); }
    });

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
